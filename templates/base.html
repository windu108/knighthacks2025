<!doctype html>
<html lang="en" data-bs-theme="dark">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
  <style>
    /* Add a basic style for the selected calendar cell */
    .calendar-cell.selected {
      background-color: #0d6efd;
      /* Bootstrap primary color */
      cursor: pointer;
    }

    .calendar-cell {
      cursor: pointer;
    }
  </style>
</head>

<body>
  <nav class="navbar sticky-top bg-body-tertiary border-bottom border-primary border-3">
    <div class="container-fluid">
      <div class="col-4 justify-content-start">
        <a class="navbar-brand" href="{{ url_for('index') }}">Meeting App</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    {% block content %}{% endblock %}
    {% block scripts %}{% endblock %}
  </div>

  <div class="container">
    <h2 class="text-center mb-4"> Profile </h2>

    <div class="mb-3">
      <label for="locationInput" class="form-label">Location</label>
      <input type="text" class="form-control" id="locationInput" placeholder="Enter your current location">
    </div>

    <div class="mb-3">
      <label for="budgetInput" class="form-label">Budget</label>
      <input type="text" class="form-control" id="budgetInput" placeholder="Enter your budget? ">
    </div>

    <div class="mt-4">
      <div class="box output-box p-3 border rounded">
        <h5>Output:</h5>
        <div id="outputText" class="mt-2 text-secondary">Waiting for input...</div>
      </div>
    </div>

    <div class="d-grid mt-4">
      <button id="submitBtn" class="btn btn-primary">Submit Data to Python Backend</button>
    </div>

    <div class="container mt-5">
      <h3 class="text-center mb-4">Simple Availability Calendar</h3>

      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle" id="calendarTable">
          <thead class="table-dark">
            <tr>
              <th>Time</th>
              <th>Mon</th>
              <th>Tue</th>
              <th>Wed</th>
              <th>Thu</th>
              <th>Fri</th>
              <th>Sat</th>
              <th>Sun</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    //==============================================================
    // SCRIPTS FOR DATA COLLECTION AND SUBMISSION TO PYTHON BACKEND
    //==============================================================
    const submitBtn = document.getElementById('submitBtn');
    const locationInput = document.getElementById('locationInput');
    const budgetInput = document.getElementById('budgetInput');
    const outputText = document.getElementById('outputText');

    /**
     * Gathers all selected time slots from the calendar table.
     * @returns {Array} An array of objects: [{day: "Mon", time: "8:00 AM"}, ...]
     */
    function collectAvailability() {
      const availability = [];
      const table = document.getElementById('calendarTable');
      const rows = table.querySelectorAll('tbody tr');

      rows.forEach((row, rowIndex) => {
        const timeCell = row.querySelector('td:first-child');
        if (!timeCell) return; // Skip if no time cell found

        const timeSlot = timeCell.textContent; // e.g., "8:00 AM"
        const dayCells = row.querySelectorAll('.calendar-cell');

        dayCells.forEach((cell, dayIndex) => {
          if (cell.classList.contains('selected')) {
            // dayIndex 0=Mon, 6=Sun
            const daysOfWeek = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
            availability.push({
              day: daysOfWeek[dayIndex],
              time: timeSlot
            });
          }
        });
      });
      return availability;
    }

    // When the button is pressed
    submitBtn.addEventListener('click', () => {
      // 1. Collect all data
      const location = locationInput.value.trim();
      const budget = budgetInput.value.trim();
      const availability = collectAvailability();

      // Basic validation
      if (location === "" || budget === "") {
        outputText.textContent = "⚠️ Please enter both Location and Budget!";
        return;
      }

      // Prepare the data payload for the server
      const postData = {
        location: location,
        budget: budget,
        availability: availability // Array of selected time slots
      };

      // 2. Show processing message
      outputText.textContent = "Processing input and sending data to Python backend...";

      // 3. Send the data to the Python backend (Flask endpoint)
      fetch('/submit_data', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(postData),
      })
        .then(response => {
          if (!response.ok) {
            // Throw an error if the HTTP status is 4xx or 5xx
            return response.json().then(err => { throw new Error(`Server responded with status ${response.status}: ${err.message || response.statusText}`); });
          }
          return response.json(); // Expect a JSON response from the Python server
        })
        .then(data => {
          // 4. Update the output box with the server's response
          const slotCount = data.slots_count !== undefined ? data.slots_count : availability.length;
          outputText.innerHTML = `✅ **Success!** Server Reply: **${data.message}**<br>Location: ${location}<br>Budget: ${budget}<br>Slots Selected: ${slotCount}`;
        })
        .catch(error => {
          console.error('Fetch error:', error);
          outputText.textContent = `❌ Error sending data: ${error.message}`;
        });
    });

    //==============================================================
    // SCRIPTS FOR CALENDAR RENDERING AND INTERACTION
    //==============================================================
    document.addEventListener("DOMContentLoaded", function () {
      const tbody = document.querySelector("#calendarTable tbody");

      // Generate time slots (8 AM to 8 PM)
      const startHour = 8;
      const endHour = 20;
      for (let hour = startHour; hour <= endHour; hour++) {
        const row = document.createElement("tr");
        const timeCell = document.createElement("td");
        const suffix = hour >= 12 ? "PM" : "AM";
        const displayHour = hour % 12 === 0 ? 12 : hour % 12;
        timeCell.textContent = `${displayHour}:00 ${suffix}`;
        timeCell.classList.add('table-secondary'); // Style the time column
        row.appendChild(timeCell);

        // Create 7 cells for days (Mon-Sun)
        for (let day = 0; day < 7; day++) {
          const cell = document.createElement("td");
          cell.classList.add("calendar-cell");
          cell.style.height = "40px";
          row.appendChild(cell);
        }

        tbody.appendChild(row);
      }

      // ---- Click & Drag Selection Logic ----
      let isMouseDown = false;
      let selecting = false; // true = selecting, false = deselecting

      document.addEventListener("mousedown", function (e) {
        if (e.target.classList.contains("calendar-cell")) {
          isMouseDown = true;
          // Determine if we are selecting (true) or deselecting (false)
          selecting = !e.target.classList.contains("selected");
          e.target.classList.toggle("selected", selecting);
        }
      });

      document.addEventListener("mouseover", function (e) {
        if (isMouseDown && e.target.classList.contains("calendar-cell")) {
          e.target.classList.toggle("selected", selecting);
        }
      });

      document.addEventListener("mouseup", function () {
        isMouseDown = false;
      });

      // Prevent text selection while dragging
      document.addEventListener("dragstart", e => e.preventDefault());
    });
  </script>

  <script src="{{ url_for('node_modules', filename='bootstrap/dist/js/bootstrap.bundle.min.js') }}"></script>
</body>

</html>